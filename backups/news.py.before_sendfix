from telegram import Update
from telegram.ext import ContextTypes
from services.news import fetch_news
from services.news_render import render_news
try:
    from services.store.chat_state import get_chat_hub
except Exception:
    def get_chat_hub(chat_id, default_hub: str = "americas"): return default_hub

async def news(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    lane = (context.args[0].lower() if context.args else "cannabis")
    hub  = get_chat_hub(chat_id, default_hub="americas")

    try:
        items = fetch_news(limit=8, lane=lane, hub=hub)
        text = (render_news(items) or "").strip()
        if not text:
            await context.bot.send_message(chat_id=chat_id, text="ðŸ—žï¸ No news right now.")
            return

        if len(text) > 3800:
            text = text[:3750] + "\nâ€¦"

        try:
            await context.bot.send_message(
                chat_id=chat_id,
                text=text,
                parse_mode="Markdown",
                disable_web_page_preview=True,
            )
        except Exception:
            await context.bot.send_message(
                chat_id=chat_id,
                text=text,
                disable_web_page_preview=True,
            )
    except Exception as e:
        await context.bot.send_message(chat_id=chat_id, text=f"ðŸŒŠ Toka drifted fetching news: {e}")

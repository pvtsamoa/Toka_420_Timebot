import logging
from scheduler.jobs import register_toka_voice_jobs
from commands import news, chatid, setchat, ritual
from telegram import Update
from commands.token import token
from commands.lang import lang
from commands.moon import moon
from commands.status import status
from scheduler.jobs import schedule_hubs
from commands.registry import register_enabled_commands
from telegram.ext import Application, CommandHandler, CommandHandler, CommandHandler, CommandHandler, CommandHandler, CommandHandler, ContextTypes

from config import TELEGRAM_BOT_TOKEN, SUA_CHAT_ID, HAS_X, DEFAULT_TOKEN
from commands.ping import ping

logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(message)s",
    level=logging.INFO,
)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸŒŠ Toka420 online. Use /status")

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    x_state = "enabled" if HAS_X else "disabled"
    await update.message.reply_text(
        f"âœ… Bot alive\nâ€” Default token: {DEFAULT_TOKEN}\nâ€” X relay: {x_state}"
    )

async def _send_heartbeat(context):
    bot = context.application.bot
    try:
        await bot.send_message(
            chat_id=int(SUA_CHAT_ID),
            text="ğŸŒ± Toka420 booted and reading .env successfully. Use /status"
        )
        logging.info("Startup heartbeat sent to %s", SUA_CHAT_ID)
    except Exception as e:
        logging.error("Failed to send startup heartbeat: %s", e)

def build_app() -> Application:
    
    app.add_handler(CommandHandler('setchat', setchat.setchat))
    app.add_handler(CommandHandler('ritual', ritual.ritual))
    app.add_handler(CommandHandler('setchat', setchat.setchat))
    register_enabled_commands(app)

    # Wire ritual scheduler
    schedule_hubs(app)
    print('ğŸ—“ï¸  Scheduler wired: schedule_hubs(app)')

    app.add_handler(CommandHandler('moon', moon))

    app.add_handler(CommandHandler("status", status))
    # Fire heartbeat right after the event loop starts
    app.job_queue.run_once(_send_heartbeat, when=0)
    return app

if __name__ == "__main__":
    application = build_app()
    application.run_polling(allowed_updates=None)


async def on_startup(app):
    # Schedule LA hub rituals at 04:00 and 04:20 PT
    register_toka_voice_jobs(app.job_queue, "America/Los_Angeles")

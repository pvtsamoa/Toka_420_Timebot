import datetime
from typing import Optional
from zoneinfo import ZoneInfo
from pathlib import Path

# ----------------------------
# Target chat persistence
# ----------------------------
_TARGET_FILE = "data/target_chat.txt"

def set_target_chat(chat_id):
    p = Path(_TARGET_FILE)
    p.parent.mkdir(parents=True, exist_ok=True)
    p.write_text(str(chat_id))
    return chat_id

def get_target_chat() -> Optional[int]:
    try:
        p = Path(_TARGET_FILE)
        if not p.exists():
            return None
        raw = p.read_text().strip()
        if not raw:
            return None
        try:
            return int(raw)
        except Exception:
            return raw  # allow string identifiers if ever used
    except Exception:
        return None

# ----------------------------
# Hub timezones for 4:20 digests
# ----------------------------
HUB_TZS = {
    "asia": "Asia/Tokyo",
    "europe": "Europe/London",
    "americas": "America/New_York",
    "oceania": "Pacific/Apia",
}

# ----------------------------
# Helpers
# ----------------------------
async def _send_telegram(context, chat_id, text, parse_md: bool = True):
    if not text:
        return
    if parse_md:
        await context.bot.send_message(chat_id=chat_id, text=text, parse_mode="Markdown")
    else:
        await context.bot.send_message(chat_id=chat_id, text=text)

def _fmt_price(p):
    try:
        p = float(p or 0)
    except Exception:
        p = 0.0
    if p == 0:
        return "$0.00"
    if p < 0.01:
        return f"${p:.6f}"
    if p < 1:
        return f"${p:.4f}"
    return f"${p:.2f}"

def _relay_enabled():
    try:
        from services.x_relay import relay_enabled
        return bool(relay_enabled())
    except Exception:
        return False

def _post_x(text: str, retries: int = 1):
    try:
        from services.x_relay import post_with_backoff
        if text:
            post_with_backoff(text, retries=retries)
    except Exception:
        pass

# ----------------------------
# Ritual jobs (Telegram first, optional X mirror)
# ----------------------------
async def job_toka_preroll(context):
    chat_id = get_target_chat()
    if not chat_id:
        return

    # Lazy imports to avoid hard crashes if optional modules are absent
    from services.render import render_ritual
    msg = render_ritual("preroll", chat_id)
    await _send_telegram(context, chat_id, msg, parse_md=False)

    # X mirror (optional)
    try:
        if _relay_enabled():
            from services.store.chat_state import get_chat_token
            from services.anchors import get_anchor
            from services.x_templates import preroll_line
            tok = get_chat_token(chat_id)
            if tok:
                a = get_anchor(tok)
                xline = preroll_line(a.get("symbol","â€”"), _fmt_price(a.get("price")))
            else:
                xline = preroll_line("â€”", "â€”")
            _post_x(xline, retries=1)
    except Exception:
        pass

async def job_toka_holy(context):
    chat_id = get_target_chat()
    if not chat_id:
        return

    from services.render import render_ritual
    msg = render_ritual("holy_minute", chat_id)
    await _send_telegram(context, chat_id, msg, parse_md=False)

    # X mirror (optional)
    try:
        if _relay_enabled():
            from services.store.chat_state import get_chat_token
            from services.anchors import get_anchor
            from services.x_templates import holy_minute_line
            tok = get_chat_token(chat_id)
            if tok:
                a = get_anchor(tok)
                xline = holy_minute_line(
                    a.get("symbol","â€”"),
                    _fmt_price(a.get("price")),
                    f"{(a.get('change24h_pct') or 0):+.2f}%"
                )
            else:
                xline = holy_minute_line("â€”", "â€”", "+0.00%")
            _post_x(xline, retries=1)
    except Exception:
        pass

# ----------------------------
# News digest jobs
# ----------------------------
async def job_toka_news_digest(context):
    """07:00 PT Dawn Digest (Americas) â€” Telegram first, optional X beacon."""
    chat_id = get_target_chat()
    if not chat_id:
        return

    from services.news import fetch_news
    from services.news_render import render_news
    items = fetch_news(limit=5, lane="cannabis", hub="americas")
    msg = "ðŸŒ… *Tokaâ€™s Dawn Digest*\n" + render_news(items)
    await _send_telegram(context, chat_id, msg, parse_md=True)

    try:
        if _relay_enabled():
            from services.x_templates import news_digest_line
            _post_x(news_digest_line("americas"), retries=1)
    except Exception:
        pass

async def _post_hub_news_420(context, hub: str):
    chat_id = get_target_chat()
    if not chat_id:
        return

    from services.news import fetch_news
    from services.news_render import render_news
    items = fetch_news(limit=5, lane="cannabis", hub=hub)
    header = f"â° 4:20 {hub.title()} Digest"
    msg = header + "\n" + render_news(items)
    await _send_telegram(context, chat_id, msg, parse_md=True)

    try:
        if _relay_enabled():
            from services.x_templates import news_digest_line
            _post_x(news_digest_line(hub), retries=1)
    except Exception:
        pass

async def job_news_420_asia(context):      await _post_hub_news_420(context, "asia")
async def job_news_420_europe(context):    await _post_hub_news_420(context, "europe")
async def job_news_420_americas(context):  await _post_hub_news_420(context, "americas")
async def job_news_420_oceania(context):   await _post_hub_news_420(context, "oceania")

# ----------------------------
# Scheduler registration
# ----------------------------
def register_toka_voice_jobs(job_queue, tzname: Optional[str] = None):
    """Register ritual + news jobs.
    - 04:00 / 04:20 America/Los_Angeles for preroll/holy.
    - 07:00 America/Los_Angeles for Dawn Digest.
    - 04:20 local time for each hub digest (Asia, Europe, Americas, Oceania).
    """
    tz_la = ZoneInfo("America/Los_Angeles")
    job_queue.run_daily(job_toka_preroll,      time=datetime.time(hour=4,  minute=0,  tzinfo=tz_la))
    job_queue.run_daily(job_toka_holy,         time=datetime.time(hour=4,  minute=20, tzinfo=tz_la))
    job_queue.run_daily(job_toka_news_digest,  time=datetime.time(hour=7,  minute=0,  tzinfo=tz_la))

    job_queue.run_daily(job_news_420_asia,     time=datetime.time(hour=4,  minute=20, tzinfo=ZoneInfo(HUB_TZS["asia"])))
    job_queue.run_daily(job_news_420_europe,   time=datetime.time(hour=4,  minute=20, tzinfo=ZoneInfo(HUB_TZS["europe"])))
    job_queue.run_daily(job_news_420_americas, time=datetime.time(hour=4,  minute=20, tzinfo=ZoneInfo(HUB_TZS["americas"])))
    job_queue.run_daily(job_news_420_oceania,  time=datetime.time(hour=4,  minute=20, tzinfo=ZoneInfo(HUB_TZS["oceania"])))

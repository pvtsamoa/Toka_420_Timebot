from __future__ import annotations
import os, logging
from pathlib import Path as _Path
from telegram.ext import Application, CommandHandler, ContextTypes

# --- Env / Logging ------------------------------------------------------------
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
if not TELEGRAM_BOT_TOKEN:
    raise RuntimeError("TELEGRAM_BOT_TOKEN missing in environment (.env)")

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s %(name)s :: %(message)s",
)
from services.news_fetcher import fetch_headlines

# --- Handlers -----------------------------------------------------------------
async def status(update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âœ… Toka is breathing. Schedules armed. ðŸŒ¿")

async def _preroll_fire(context):
    chat_id = context.job.data
    await context.bot.send_message(chat_id=chat_id, text="ðŸ”¥ Pre-roll: test 4:20 ritual fired.")

async def preroll(update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    when = 60  # seconds
    context.job_queue.run_once(_preroll_fire, when, data=chat_id, name="preroll_test")
    await update.message.reply_text("ðŸ•’ Pre-roll armed â€” will fire in ~60s.")

NEWS_DIR = _Path("data/news")

def _trim(text: str, limit: int = 180) -> str:
    t = text.strip()
    if len(t) <= limit:
        return t
    return t[:limit-1].rstrip() + "â€¦"

def _pick_news(region: str, limit: int = 180) -> str:
    try:
        f = NEWS_DIR / f"{region.lower()}.txt"
        if not f.exists():
            return f"[no pool for {region}]"
        lines = [
            ln.strip() for ln in f.read_text(encoding="utf-8").splitlines()
            if ln.strip() and not ln.lstrip().startswith("#")
        ]
        if not lines:
            return f"[pool empty: {region}]"
        import random as _rnd
        return _trim(_rnd.choice(lines), limit)
    except Exception as e:
        return f"[error: {type(e).__name__}]"

async def news(update, context: ContextTypes.DEFAULT_TYPE):
    regions_env = os.getenv("NEWS_SOURCES", None)  # comma URLs; fallback inside fetcher
    # Try live headlines first
    live = []
    try:
        live = fetch_headlines(regions_env, max_items=6)
    except Exception:
        live = []
    if live:
        lines = [f"â€¢ {t} â€” {src}
{u}" for (t,u,src) in live]
{u}" for (t,u,src) in live]
        msg = "ðŸ—žï¸ Crypto & Cannabis headlines
" + "

".join(lines)
        if len(msg) > 3500: msg = msg[:3499]
        await update.message.reply_text(msg)
        return

    # Fallback to local pools by region names (previous behavior)
    regions_env = os.getenv("NEWS_REGIONS", "Samoa,California,London")
    regions = context.args or [r.strip() for r in regions_env.split(",") if r.strip()]
    regions = regions[:6]
    try:
        NEWS_DIR.mkdir(parents=True, exist_ok=True)
    except Exception:
        pass
    bits = [f"â€¢ {r}: {_pick_news(r)}" for r in regions]
    msg = "ðŸ—žï¸ Headlines
" + "
".join(bits)
    if len(msg) > 3500: msg = msg[:3499]
    await update.message.reply_text(msg)

# --- Optional scheduler hook (safe if missing) --------------------------------
try:
    from scheduler import schedule_hubs  # your hub scheduler
except Exception:
    schedule_hubs = None

try:
    from services.ritual_time import ritual_call  # job fired at each 4:20
except Exception:
    ritual_call = None

# --- Build Application & wire handlers ----------------------------------------
def build_app() -> Application:
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    # Register command handlers (idempotent)
    existing = {
        h.command[0] for h in application.handlers.get(0, [])
        if hasattr(h, "command") and h.command
    }
    if "status" not in existing:
        application.add_handler(CommandHandler("status", status))
    if "preroll" not in existing:
        application.add_handler(CommandHandler("preroll", preroll))
    if "news" not in existing:
        application.add_handler(CommandHandler("news", news))

    # Schedule 4:20 jobs if the modules are available
    if schedule_hubs and ritual_call:
        schedule_hubs(application.job_queue, ritual_call)

    return application

# --- Entrypoint ----------------------------------------------------------------
if __name__ == "__main__":
    app = build_app()
    app.run_polling()
